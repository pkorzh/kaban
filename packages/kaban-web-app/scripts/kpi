#!/usr/bin/env node
const util = require('util')

require('../api/dal/connect')
const { TicketSpentIn } = require('../api/dal/models')

async function main() {
	//await TicketSpentIn.update({}, {$set: {backlog: {key: 'AMA'}}}, {multi:true})

	let stats = await TicketSpentIn.aggregate([
		{
			$group: {
				_id: '$status.key',
				ms: {
					$push: '$ms'
				},
			},
		},
		{
			$unwind: '$ms'
		},
		{
			$sort: {'ms': 1}
		},
		{
			$group: {
				_id: '$_id',
				ms: {
					$push: '$ms'
				}
			}
		},
		{
			$project: {
				_id: '$_id',
				avg: { $floor: { $avg: '$ms' } },
				p50: {'$arrayElemAt': ['$ms', {'$floor': {'$multiply': [0.5, {'$size': '$ms'}]}}]},
				p99: {'$arrayElemAt': ['$ms', {'$floor': {'$multiply': [0.99, {'$size': '$ms'}]}}]},
				ms: { $push: '$ms' },
			}
		},
		{
			$group: {
				_id: '$_id',
				s: {
					$push: { $subtract: [ '$ms', '$avg' ] }
				}
			}
		}
	])

	//console.debug('total tickets ', Object.keys(stats).length)
	console.debug(util.inspect(stats, false, null))

	process.exit()
}

main()
